"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var themes = _interopRequireWildcard(require("redux-devtools-themes"));

var _reduxDevtools = require("redux-devtools");

var _actions = require("./actions");

var _reducers = _interopRequireDefault(require("./reducers"));

var _LogMonitorButtonBar = _interopRequireDefault(require("./LogMonitorButtonBar"));

var _LogMonitorEntryList = _interopRequireDefault(require("./LogMonitorEntryList"));

var _lodash = _interopRequireDefault(require("lodash.debounce"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }

function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

// eslint-disable-next-line @typescript-eslint/unbound-method
var toggleAction = _reduxDevtools.ActionCreators.toggleAction,
    setActionsActive = _reduxDevtools.ActionCreators.setActionsActive;
var styles = {
  container: {
    fontFamily: 'monaco, Consolas, Lucida Console, monospace',
    position: 'relative',
    overflowY: 'hidden',
    width: '100%',
    height: '100%',
    minWidth: 300,
    direction: 'ltr'
  },
  elements: {
    position: 'absolute',
    left: 0,
    right: 0,
    top: 0,
    bottom: 0,
    overflowX: 'hidden',
    overflowY: 'auto'
  }
};

var LogMonitor = /*#__PURE__*/function (_PureComponent) {
  _inherits(LogMonitor, _PureComponent);

  var _super = _createSuper(LogMonitor);

  function LogMonitor() {
    var _this;

    _classCallCheck(this, LogMonitor);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = _super.call.apply(_super, [this].concat(args));

    _defineProperty(_assertThisInitialized(_this), "scrollDown", void 0);

    _defineProperty(_assertThisInitialized(_this), "node", void 0);

    _defineProperty(_assertThisInitialized(_this), "updateScrollTop", (0, _lodash["default"])(function () {
      var node = _this.node;

      _this.props.dispatch((0, _actions.updateScrollTop)(node ? node.scrollTop : 0));
    }, 500));

    _defineProperty(_assertThisInitialized(_this), "handleToggleAction", function (id) {
      _this.props.dispatch(toggleAction(id));
    });

    _defineProperty(_assertThisInitialized(_this), "handleToggleConsecutiveAction", function (id) {
      var _this$props = _this.props,
          monitorState = _this$props.monitorState,
          actionsById = _this$props.actionsById;
      var consecutiveToggleStartId = monitorState.consecutiveToggleStartId;

      if (consecutiveToggleStartId && actionsById[consecutiveToggleStartId]) {
        var skippedActionIds = _this.props.skippedActionIds;
        var start = Math.min(consecutiveToggleStartId, id);
        var end = Math.max(consecutiveToggleStartId, id);
        var active = skippedActionIds.indexOf(consecutiveToggleStartId) > -1;

        _this.props.dispatch(setActionsActive(start, end + 1, active));

        _this.props.dispatch((0, _actions.startConsecutiveToggle)(null));
      } else if (id > 0) {
        _this.props.dispatch((0, _actions.startConsecutiveToggle)(id));
      }
    });

    _defineProperty(_assertThisInitialized(_this), "getRef", function (node) {
      _this.node = node;
    });

    return _this;
  }

  _createClass(LogMonitor, [{
    key: "scroll",
    value: function scroll() {
      var node = this.node;

      if (!node) {
        return;
      }

      if (this.scrollDown) {
        var offsetHeight = node.offsetHeight,
            scrollHeight = node.scrollHeight;
        node.scrollTop = scrollHeight - offsetHeight;
        this.scrollDown = false;
      }
    }
  }, {
    key: "componentDidMount",
    value: function componentDidMount() {
      var node = this.node;

      if (!node || !this.props.monitorState) {
        return;
      }

      if (this.props.preserveScrollTop) {
        node.scrollTop = this.props.monitorState.initialScrollTop;
        node.addEventListener('scroll', this.updateScrollTop);
      } else {
        this.scrollDown = true;
        this.scroll();
      }
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      var node = this.node;

      if (node && this.props.preserveScrollTop) {
        node.removeEventListener('scroll', this.updateScrollTop);
      }
    }
  }, {
    key: "UNSAFE_componentWillReceiveProps",
    value: function UNSAFE_componentWillReceiveProps(nextProps) {
      var node = this.node;

      if (!node) {
        this.scrollDown = true;
      } else if (this.props.stagedActionIds.length < nextProps.stagedActionIds.length) {
        var scrollTop = node.scrollTop,
            offsetHeight = node.offsetHeight,
            scrollHeight = node.scrollHeight;
        this.scrollDown = Math.abs(scrollHeight - (scrollTop + offsetHeight)) < 20;
      } else {
        this.scrollDown = false;
      }
    }
  }, {
    key: "componentDidUpdate",
    value: function componentDidUpdate() {
      this.scroll();
    }
  }, {
    key: "getTheme",
    value: function getTheme() {
      var theme = this.props.theme;

      if (typeof theme !== 'string') {
        return theme;
      }

      if (typeof themes[theme] !== 'undefined') {
        return themes[theme];
      } // eslint-disable-next-line no-console


      console.warn('DevTools theme ' + theme + ' not found, defaulting to nicinabox');
      return themes.nicinabox;
    }
  }, {
    key: "render",
    value: function render() {
      var theme = this.getTheme();
      var consecutiveToggleStartId = this.props.monitorState.consecutiveToggleStartId;
      var _this$props2 = this.props,
          dispatch = _this$props2.dispatch,
          actionsById = _this$props2.actionsById,
          skippedActionIds = _this$props2.skippedActionIds,
          stagedActionIds = _this$props2.stagedActionIds,
          computedStates = _this$props2.computedStates,
          currentStateIndex = _this$props2.currentStateIndex,
          select = _this$props2.select,
          expandActionRoot = _this$props2.expandActionRoot,
          expandStateRoot = _this$props2.expandStateRoot,
          markStateDiff = _this$props2.markStateDiff;
      var entryListProps = {
        theme: theme,
        actionsById: actionsById,
        skippedActionIds: skippedActionIds,
        stagedActionIds: stagedActionIds,
        computedStates: computedStates,
        currentStateIndex: currentStateIndex,
        consecutiveToggleStartId: consecutiveToggleStartId,
        select: select,
        expandActionRoot: expandActionRoot,
        expandStateRoot: expandStateRoot,
        markStateDiff: markStateDiff,
        onActionClick: this.handleToggleAction,
        onActionShiftClick: this.handleToggleConsecutiveAction
      };
      return /*#__PURE__*/_react["default"].createElement("div", {
        style: _objectSpread(_objectSpread({}, styles.container), {}, {
          backgroundColor: theme.base00
        })
      }, !this.props.hideMainButtons && /*#__PURE__*/_react["default"].createElement(_LogMonitorButtonBar["default"], {
        theme: theme,
        dispatch: dispatch,
        hasStates: computedStates.length > 1,
        hasSkippedActions: skippedActionIds.length > 0
      }), /*#__PURE__*/_react["default"].createElement("div", {
        style: this.props.hideMainButtons ? styles.elements : _objectSpread(_objectSpread({}, styles.elements), {}, {
          top: 30
        }),
        ref: this.getRef
      }, /*#__PURE__*/_react["default"].createElement(_LogMonitorEntryList["default"], entryListProps)));
    }
  }]);

  return LogMonitor;
}(_react.PureComponent);

_defineProperty(LogMonitor, "update", _reducers["default"]);

_defineProperty(LogMonitor, "propTypes", {
  dispatch: _propTypes["default"].func,
  computedStates: _propTypes["default"].array,
  actionsById: _propTypes["default"].object,
  stagedActionIds: _propTypes["default"].array,
  skippedActionIds: _propTypes["default"].array,
  monitorState: _propTypes["default"].shape({
    initialScrollTop: _propTypes["default"].number,
    consecutiveToggleStartId: _propTypes["default"].number
  }),
  preserveScrollTop: _propTypes["default"].bool,
  select: _propTypes["default"].func,
  theme: _propTypes["default"].oneOfType([_propTypes["default"].object, _propTypes["default"].string]),
  expandActionRoot: _propTypes["default"].bool,
  expandStateRoot: _propTypes["default"].bool,
  markStateDiff: _propTypes["default"].bool,
  hideMainButtons: _propTypes["default"].bool
});

_defineProperty(LogMonitor, "defaultProps", {
  select: function select(state) {
    return state;
  },
  theme: 'nicinabox',
  preserveScrollTop: true,
  expandActionRoot: true,
  expandStateRoot: true,
  markStateDiff: false
});

var _default = LogMonitor;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Mb2dNb25pdG9yLnRzeCJdLCJuYW1lcyI6WyJ0b2dnbGVBY3Rpb24iLCJBY3Rpb25DcmVhdG9ycyIsInNldEFjdGlvbnNBY3RpdmUiLCJzdHlsZXMiLCJjb250YWluZXIiLCJmb250RmFtaWx5IiwicG9zaXRpb24iLCJvdmVyZmxvd1kiLCJ3aWR0aCIsImhlaWdodCIsIm1pbldpZHRoIiwiZGlyZWN0aW9uIiwiZWxlbWVudHMiLCJsZWZ0IiwicmlnaHQiLCJ0b3AiLCJib3R0b20iLCJvdmVyZmxvd1giLCJMb2dNb25pdG9yIiwibm9kZSIsInByb3BzIiwiZGlzcGF0Y2giLCJzY3JvbGxUb3AiLCJpZCIsIm1vbml0b3JTdGF0ZSIsImFjdGlvbnNCeUlkIiwiY29uc2VjdXRpdmVUb2dnbGVTdGFydElkIiwic2tpcHBlZEFjdGlvbklkcyIsInN0YXJ0IiwiTWF0aCIsIm1pbiIsImVuZCIsIm1heCIsImFjdGl2ZSIsImluZGV4T2YiLCJzY3JvbGxEb3duIiwib2Zmc2V0SGVpZ2h0Iiwic2Nyb2xsSGVpZ2h0IiwicHJlc2VydmVTY3JvbGxUb3AiLCJpbml0aWFsU2Nyb2xsVG9wIiwiYWRkRXZlbnRMaXN0ZW5lciIsInVwZGF0ZVNjcm9sbFRvcCIsInNjcm9sbCIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJuZXh0UHJvcHMiLCJzdGFnZWRBY3Rpb25JZHMiLCJsZW5ndGgiLCJhYnMiLCJ0aGVtZSIsInRoZW1lcyIsImNvbnNvbGUiLCJ3YXJuIiwibmljaW5hYm94IiwiZ2V0VGhlbWUiLCJjb21wdXRlZFN0YXRlcyIsImN1cnJlbnRTdGF0ZUluZGV4Iiwic2VsZWN0IiwiZXhwYW5kQWN0aW9uUm9vdCIsImV4cGFuZFN0YXRlUm9vdCIsIm1hcmtTdGF0ZURpZmYiLCJlbnRyeUxpc3RQcm9wcyIsIm9uQWN0aW9uQ2xpY2siLCJoYW5kbGVUb2dnbGVBY3Rpb24iLCJvbkFjdGlvblNoaWZ0Q2xpY2siLCJoYW5kbGVUb2dnbGVDb25zZWN1dGl2ZUFjdGlvbiIsImJhY2tncm91bmRDb2xvciIsImJhc2UwMCIsImhpZGVNYWluQnV0dG9ucyIsImdldFJlZiIsIlB1cmVDb21wb25lbnQiLCJyZWR1Y2VyIiwiUHJvcFR5cGVzIiwiZnVuYyIsImFycmF5Iiwib2JqZWN0Iiwic2hhcGUiLCJudW1iZXIiLCJib29sIiwib25lT2ZUeXBlIiwic3RyaW5nIiwic3RhdGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFLQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBSUE7SUFDUUEsWSxHQUFtQ0MsNkIsQ0FBbkNELFk7SUFBY0UsZ0IsR0FBcUJELDZCLENBQXJCQyxnQjtBQUV0QixJQUFNQyxNQUdMLEdBQUc7QUFDRkMsRUFBQUEsU0FBUyxFQUFFO0FBQ1RDLElBQUFBLFVBQVUsRUFBRSw2Q0FESDtBQUVUQyxJQUFBQSxRQUFRLEVBQUUsVUFGRDtBQUdUQyxJQUFBQSxTQUFTLEVBQUUsUUFIRjtBQUlUQyxJQUFBQSxLQUFLLEVBQUUsTUFKRTtBQUtUQyxJQUFBQSxNQUFNLEVBQUUsTUFMQztBQU1UQyxJQUFBQSxRQUFRLEVBQUUsR0FORDtBQU9UQyxJQUFBQSxTQUFTLEVBQUU7QUFQRixHQURUO0FBVUZDLEVBQUFBLFFBQVEsRUFBRTtBQUNSTixJQUFBQSxRQUFRLEVBQUUsVUFERjtBQUVSTyxJQUFBQSxJQUFJLEVBQUUsQ0FGRTtBQUdSQyxJQUFBQSxLQUFLLEVBQUUsQ0FIQztBQUlSQyxJQUFBQSxHQUFHLEVBQUUsQ0FKRztBQUtSQyxJQUFBQSxNQUFNLEVBQUUsQ0FMQTtBQU1SQyxJQUFBQSxTQUFTLEVBQUUsUUFOSDtBQU9SVixJQUFBQSxTQUFTLEVBQUU7QUFQSDtBQVZSLENBSEo7O0lBMERNVyxVOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztzRUFxQ2Msd0JBQVMsWUFBTTtBQUMvQixVQUFNQyxJQUFJLEdBQUcsTUFBS0EsSUFBbEI7O0FBQ0EsWUFBS0MsS0FBTCxDQUFX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QUFDUCxzQkFBVUcsTUFBWCxFQUFtQkgsc0JBQVVRLE1BQTdCLENBQXBCLENBYlU7QUFjakJ0QixFQUFBQSxnQkFBZ0IsRUFBRWMsc0JBQVVNLElBZFg7QUFlakJuQixFQUFBQSxlQUFlLEVBQUVhLHNCQUFVTSxJQWZWO0FBZ0JqQmxCLEVBQUFBLGFBQWEsRUFBRVksc0JBQVVNLElBaEJSO0FBaUJqQlYsRUFBQUEsZUFBZSxFQUFFSSxzQkFBVU07QUFqQlYsQzs7Z0JBTGYzRCxVLGtCQXlCeUM7QUFDM0NzQyxFQUFBQSxNQUFNLEVBQUUsZ0JBQUN3QixLQUFEO0FBQUEsV0FBb0JBLEtBQXBCO0FBQUEsR0FEbUM7QUFFM0NoQyxFQUFBQSxLQUFLLEVBQUUsV0FGb0M7QUFHM0NWLEVBQUFBLGlCQUFpQixFQUFFLElBSHdCO0FBSTNDbUIsRUFBQUEsZ0JBQWdCLEVBQUUsSUFKeUI7QUFLM0NDLEVBQUFBLGVBQWUsRUFBRSxJQUwwQjtBQU0zQ0MsRUFBQUEsYUFBYSxFQUFFO0FBTjRCLEM7O2VBeUsvQnpDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgUHVyZUNvbXBvbmVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgeyBBY3Rpb24sIERpc3BhdGNoIH0gZnJvbSAncmVkdXgnO1xuaW1wb3J0ICogYXMgdGhlbWVzIGZyb20gJ3JlZHV4LWRldnRvb2xzLXRoZW1lcyc7XG5pbXBvcnQgeyBCYXNlMTZUaGVtZSB9IGZyb20gJ3JlZHV4LWRldnRvb2xzLXRoZW1lcyc7XG5pbXBvcnQgeyBBY3Rpb25DcmVhdG9ycywgTGlmdGVkQWN0aW9uLCBMaWZ0ZWRTdGF0ZSB9IGZyb20gJ3JlZHV4LWRldnRvb2xzJztcbmltcG9ydCB7XG4gIHVwZGF0ZVNjcm9sbFRvcCxcbiAgc3RhcnRDb25zZWN1dGl2ZVRvZ2dsZSxcbiAgTG9nTW9uaXRvckFjdGlvbixcbn0gZnJvbSAnLi9hY3Rpb25zJztcbmltcG9ydCByZWR1Y2VyLCB7IExvZ01vbml0b3JTdGF0ZSB9IGZyb20gJy4vcmVkdWNlcnMnO1xuaW1wb3J0IExvZ01vbml0b3JCdXR0b25CYXIgZnJvbSAnLi9Mb2dNb25pdG9yQnV0dG9uQmFyJztcbmltcG9ydCBMb2dNb25pdG9yRW50cnlMaXN0IGZyb20gJy4vTG9nTW9uaXRvckVudHJ5TGlzdCc7XG5pbXBvcnQgZGVib3VuY2UgZnJvbSAnbG9kYXNoLmRlYm91bmNlJztcbmltcG9ydCB7IERvY2tNb25pdG9yU3RhdGUgfSBmcm9tICdyZWR1eC1kZXZ0b29scy1kb2NrLW1vbml0b3IvbGliL3JlZHVjZXJzJztcbmltcG9ydCB7IERvY2tNb25pdG9yQWN0aW9uIH0gZnJvbSAncmVkdXgtZGV2dG9vbHMtZG9jay1tb25pdG9yL2xpYi9hY3Rpb25zJztcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC91bmJvdW5kLW1ldGhvZFxuY29uc3QgeyB0b2dnbGVBY3Rpb24sIHNldEFjdGlvbnNBY3RpdmUgfSA9IEFjdGlvbkNyZWF0b3JzO1xuXG5jb25zdCBzdHlsZXM6IHtcbiAgY29udGFpbmVyOiBSZWFjdC5DU1NQcm9wZXJ0aWVzO1xuICBlbGVtZW50czogUmVhY3QuQ1NTUHJvcGVydGllcztcbn0gPSB7XG4gIGNvbnRhaW5lcjoge1xuICAgIGZvbnRGYW1pbHk6ICdtb25hY28sIENvbnNvbGFzLCBMdWNpZGEgQ29uc29sZSwgbW9ub3NwYWNlJyxcbiAgICBwb3NpdGlvbjogJ3JlbGF0aXZlJyxcbiAgICBvdmVyZmxvd1k6ICdoaWRkZW4nLFxuICAgIHdpZHRoOiAnMTAwJScsXG4gICAgaGVpZ2h0OiAnMTAwJScsXG4gICAgbWluV2lkdGg6IDMwMCxcbiAgICBkaXJlY3Rpb246ICdsdHInLFxuICB9LFxuICBlbGVtZW50czoge1xuICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLFxuICAgIGxlZnQ6IDAsXG4gICAgcmlnaHQ6IDAsXG4gICAgdG9wOiAwLFxuICAgIGJvdHRvbTogMCxcbiAgICBvdmVyZmxvd1g6ICdoaWRkZW4nLFxuICAgIG92ZXJmbG93WTogJ2F1dG8nLFxuICB9LFxufTtcblxuaW50ZXJmYWNlIEV4dGVybmFsUHJvcHM8UywgQSBleHRlbmRzIEFjdGlvbjx1bmtub3duPj4ge1xuICBkaXNwYXRjaDogRGlzcGF0Y2g8TG9nTW9uaXRvckFjdGlvbiB8IExpZnRlZEFjdGlvbjxTLCBBLCBMb2dNb25pdG9yU3RhdGU+PjtcblxuICBwcmVzZXJ2ZVNjcm9sbFRvcDogYm9vbGVhbjtcbiAgc2VsZWN0OiAoc3RhdGU6IFMpID0+IHVua25vd247XG4gIHRoZW1lOiBrZXlvZiB0eXBlb2YgdGhlbWVzIHwgQmFzZTE2VGhlbWU7XG4gIGV4cGFuZEFjdGlvblJvb3Q6IGJvb2xlYW47XG4gIGV4cGFuZFN0YXRlUm9vdDogYm9vbGVhbjtcbiAgbWFya1N0YXRlRGlmZjogYm9vbGVhbjtcbiAgaGlkZU1haW5CdXR0b25zPzogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIERlZmF1bHRQcm9wczxTPiB7XG4gIHNlbGVjdDogKHN0YXRlOiB1bmtub3duKSA9PiB1bmtub3duO1xuICB0aGVtZToga2V5b2YgdHlwZW9mIHRoZW1lcyB8IEJhc2UxNlRoZW1lO1xuICBwcmVzZXJ2ZVNjcm9sbFRvcDogYm9vbGVhbjtcbiAgZXhwYW5kQWN0aW9uUm9vdDogYm9vbGVhbjtcbiAgZXhwYW5kU3RhdGVSb290OiBib29sZWFuO1xuICBtYXJrU3RhdGVEaWZmOiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIExvZ01vbml0b3JQcm9wczxTLCBBIGV4dGVuZHMgQWN0aW9uPHVua25vd24+PlxuICBleHRlbmRzIExpZnRlZFN0YXRlPFMsIEEsIExvZ01vbml0b3JTdGF0ZT4ge1xuICBkaXNwYXRjaDogRGlzcGF0Y2g8TG9nTW9uaXRvckFjdGlvbiB8IExpZnRlZEFjdGlvbjxTLCBBLCBMb2dNb25pdG9yU3RhdGU+PjtcblxuICBwcmVzZXJ2ZVNjcm9sbFRvcDogYm9vbGVhbjtcbiAgc2VsZWN0OiAoc3RhdGU6IFMpID0+IHVua25vd247XG4gIHRoZW1lOiBrZXlvZiB0eXBlb2YgdGhlbWVzIHwgQmFzZTE2VGhlbWU7XG4gIGV4cGFuZEFjdGlvblJvb3Q6IGJvb2xlYW47XG4gIGV4cGFuZFN0YXRlUm9vdDogYm9vbGVhbjtcbiAgbWFya1N0YXRlRGlmZjogYm9vbGVhbjtcbiAgaGlkZU1haW5CdXR0b25zPzogYm9vbGVhbjtcbn1cblxuY2xhc3MgTG9nTW9uaXRvcjxTLCBBIGV4dGVuZHMgQWN0aW9uPHVua25vd24+PiBleHRlbmRzIFB1cmVDb21wb25lbnQ8XG4gIExvZ01vbml0b3JQcm9wczxTLCBBPlxuPiB7XG4gIHN0YXRpYyB1cGRhdGUgPSByZWR1Y2VyO1xuXG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgZGlzcGF0Y2g6IFByb3BUeXBlcy5mdW5jLFxuICAgIGNvbXB1dGVkU3RhdGVzOiBQcm9wVHlwZXMuYXJyYXksXG4gICAgYWN0aW9uc0J5SWQ6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgc3RhZ2VkQWN0aW9uSWRzOiBQcm9wVHlwZXMuYXJyYXksXG4gICAgc2tpcHBlZEFjdGlvbklkczogUHJvcFR5cGVzLmFycmF5LFxuICAgIG1vbml0b3JTdGF0ZTogUHJvcFR5cGVzLnNoYXBlKHtcbiAgICAgIGluaXRpYWxTY3JvbGxUb3A6IFByb3BUeXBlcy5udW1iZXIsXG4gICAgICBjb25zZWN1dGl2ZVRvZ2dsZVN0YXJ0SWQ6IFByb3BUeXBlcy5udW1iZXIsXG4gICAgfSksXG5cbiAgICBwcmVzZXJ2ZVNjcm9sbFRvcDogUHJvcFR5cGVzLmJvb2wsXG4gICAgc2VsZWN0OiBQcm9wVHlwZXMuZnVuYyxcbiAgICB0aGVtZTogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLm9iamVjdCwgUHJvcFR5cGVzLnN0cmluZ10pLFxuICAgIGV4cGFuZEFjdGlvblJvb3Q6IFByb3BUeXBlcy5ib29sLFxuICAgIGV4cGFuZFN0YXRlUm9vdDogUHJvcFR5cGVzLmJvb2wsXG4gICAgbWFya1N0YXRlRGlmZjogUHJvcFR5cGVzLmJvb2wsXG4gICAgaGlkZU1haW5CdXR0b25zOiBQcm9wVHlwZXMuYm9vbCxcbiAgfTtcblxuICBzdGF0aWMgZGVmYXVsdFByb3BzOiBEZWZhdWx0UHJvcHM8dW5rbm93bj4gPSB7XG4gICAgc2VsZWN0OiAoc3RhdGU6IHVua25vd24pID0+IHN0YXRlLFxuICAgIHRoZW1lOiAnbmljaW5hYm94JyxcbiAgICBwcmVzZXJ2ZVNjcm9sbFRvcDogdHJ1ZSxcbiAgICBleHBhbmRBY3Rpb25Sb290OiB0cnVlLFxuICAgIGV4cGFuZFN0YXRlUm9vdDogdHJ1ZSxcbiAgICBtYXJrU3RhdGVEaWZmOiBmYWxzZSxcbiAgfTtcblxuICBzY3JvbGxEb3duPzogYm9vbGVhbjtcbiAgbm9kZT86IEhUTUxEaXZFbGVtZW50IHwgbnVsbDtcblxuICB1cGRhdGVTY3JvbGxUb3AgPSBkZWJvdW5jZSgoKSA9PiB7XG4gICAgY29uc3Qgbm9kZSA9IHRoaXMubm9kZTtcbiAgICB0aGlzLnByb3BzLmRpc3BhdGNoKHVwZGF0ZVNjcm9sbFRvcChub2RlID8gbm9kZS5zY3JvbGxUb3AgOiAwKSk7XG4gIH0sIDUwMCk7XG5cbiAgc2Nyb2xsKCkge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGU7XG4gICAgaWYgKCFub2RlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLnNjcm9sbERvd24pIHtcbiAgICAgIGNvbnN0IHsgb2Zmc2V0SGVpZ2h0LCBzY3JvbGxIZWlnaHQgfSA9IG5vZGU7XG4gICAgICBub2RlLnNjcm9sbFRvcCA9IHNjcm9sbEhlaWdodCAtIG9mZnNldEhlaWdodDtcbiAgICAgIHRoaXMuc2Nyb2xsRG93biA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGU7XG4gICAgaWYgKCFub2RlIHx8ICF0aGlzLnByb3BzLm1vbml0b3JTdGF0ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnByb3BzLnByZXNlcnZlU2Nyb2xsVG9wKSB7XG4gICAgICBub2RlLnNjcm9sbFRvcCA9IHRoaXMucHJvcHMubW9uaXRvclN0YXRlLmluaXRpYWxTY3JvbGxUb3A7XG4gICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMudXBkYXRlU2Nyb2xsVG9wKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zY3JvbGxEb3duID0gdHJ1ZTtcbiAgICAgIHRoaXMuc2Nyb2xsKCk7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgY29uc3Qgbm9kZSA9IHRoaXMubm9kZTtcbiAgICBpZiAobm9kZSAmJiB0aGlzLnByb3BzLnByZXNlcnZlU2Nyb2xsVG9wKSB7XG4gICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMudXBkYXRlU2Nyb2xsVG9wKTtcbiAgICB9XG4gIH1cblxuICBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHM6IExvZ01vbml0b3JQcm9wczxTLCBBPikge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGU7XG4gICAgaWYgKCFub2RlKSB7XG4gICAgICB0aGlzLnNjcm9sbERvd24gPSB0cnVlO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICB0aGlzLnByb3BzLnN0YWdlZEFjdGlvbklkcy5sZW5ndGggPCBuZXh0UHJvcHMuc3RhZ2VkQWN0aW9uSWRzLmxlbmd0aFxuICAgICkge1xuICAgICAgY29uc3QgeyBzY3JvbGxUb3AsIG9mZnNldEhlaWdodCwgc2Nyb2xsSGVpZ2h0IH0gPSBub2RlO1xuXG4gICAgICB0aGlzLnNjcm9sbERvd24gPVxuICAgICAgICBNYXRoLmFicyhzY3JvbGxIZWlnaHQgLSAoc2Nyb2xsVG9wICsgb2Zmc2V0SGVpZ2h0KSkgPCAyMDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zY3JvbGxEb3duID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgIHRoaXMuc2Nyb2xsKCk7XG4gIH1cblxuICBoYW5kbGVUb2dnbGVBY3Rpb24gPSAoaWQ6IG51bWJlcikgPT4ge1xuICAgIHRoaXMucHJvcHMuZGlzcGF0Y2godG9nZ2xlQWN0aW9uKGlkKSk7XG4gIH07XG5cbiAgaGFuZGxlVG9nZ2xlQ29uc2VjdXRpdmVBY3Rpb24gPSAoaWQ6IG51bWJlcikgPT4ge1xuICAgIGNvbnN0IHsgbW9uaXRvclN0YXRlLCBhY3Rpb25zQnlJZCB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7IGNvbnNlY3V0aXZlVG9nZ2xlU3RhcnRJZCB9ID0gbW9uaXRvclN0YXRlO1xuICAgIGlmIChjb25zZWN1dGl2ZVRvZ2dsZVN0YXJ0SWQgJiYgYWN0aW9uc0J5SWRbY29uc2VjdXRpdmVUb2dnbGVTdGFydElkXSkge1xuICAgICAgY29uc3QgeyBza2lwcGVkQWN0aW9uSWRzIH0gPSB0aGlzLnByb3BzO1xuICAgICAgY29uc3Qgc3RhcnQgPSBNYXRoLm1pbihjb25zZWN1dGl2ZVRvZ2dsZVN0YXJ0SWQsIGlkKTtcbiAgICAgIGNvbnN0IGVuZCA9IE1hdGgubWF4KGNvbnNlY3V0aXZlVG9nZ2xlU3RhcnRJZCwgaWQpO1xuICAgICAgY29uc3QgYWN0aXZlID0gc2tpcHBlZEFjdGlvbklkcy5pbmRleE9mKGNvbnNlY3V0aXZlVG9nZ2xlU3RhcnRJZCkgPiAtMTtcbiAgICAgIHRoaXMucHJvcHMuZGlzcGF0Y2goc2V0QWN0aW9uc0FjdGl2ZShzdGFydCwgZW5kICsgMSwgYWN0aXZlKSk7XG4gICAgICB0aGlzLnByb3BzLmRpc3BhdGNoKHN0YXJ0Q29uc2VjdXRpdmVUb2dnbGUobnVsbCkpO1xuICAgIH0gZWxzZSBpZiAoaWQgPiAwKSB7XG4gICAgICB0aGlzLnByb3BzLmRpc3BhdGNoKHN0YXJ0Q29uc2VjdXRpdmVUb2dnbGUoaWQpKTtcbiAgICB9XG4gIH07XG5cbiAgZ2V0VGhlbWUoKSB7XG4gICAgY29uc3QgeyB0aGVtZSB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAodHlwZW9mIHRoZW1lICE9PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHRoZW1lO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgdGhlbWVzW3RoZW1lXSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHJldHVybiB0aGVtZXNbdGhlbWVdO1xuICAgIH1cblxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgY29uc29sZS53YXJuKFxuICAgICAgJ0RldlRvb2xzIHRoZW1lICcgKyB0aGVtZSArICcgbm90IGZvdW5kLCBkZWZhdWx0aW5nIHRvIG5pY2luYWJveCdcbiAgICApO1xuICAgIHJldHVybiB0aGVtZXMubmljaW5hYm94O1xuICB9XG5cbiAgZ2V0UmVmOiBSZWFjdC5SZWZDYWxsYmFjazxIVE1MRGl2RWxlbWVudD4gPSAobm9kZSkgPT4ge1xuICAgIHRoaXMubm9kZSA9IG5vZGU7XG4gIH07XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHRoZW1lID0gdGhpcy5nZXRUaGVtZSgpO1xuICAgIGNvbnN0IHsgY29uc2VjdXRpdmVUb2dnbGVTdGFydElkIH0gPSB0aGlzLnByb3BzLm1vbml0b3JTdGF0ZTtcblxuICAgIGNvbnN0IHtcbiAgICAgIGRpc3BhdGNoLFxuICAgICAgYWN0aW9uc0J5SWQsXG4gICAgICBza2lwcGVkQWN0aW9uSWRzLFxuICAgICAgc3RhZ2VkQWN0aW9uSWRzLFxuICAgICAgY29tcHV0ZWRTdGF0ZXMsXG4gICAgICBjdXJyZW50U3RhdGVJbmRleCxcbiAgICAgIHNlbGVjdCxcbiAgICAgIGV4cGFuZEFjdGlvblJvb3QsXG4gICAgICBleHBhbmRTdGF0ZVJvb3QsXG4gICAgICBtYXJrU3RhdGVEaWZmLFxuICAgIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgY29uc3QgZW50cnlMaXN0UHJvcHMgPSB7XG4gICAgICB0aGVtZSxcbiAgICAgIGFjdGlvbnNCeUlkLFxuICAgICAgc2tpcHBlZEFjdGlvbklkcyxcbiAgICAgIHN0YWdlZEFjdGlvbklkcyxcbiAgICAgIGNvbXB1dGVkU3RhdGVzLFxuICAgICAgY3VycmVudFN0YXRlSW5kZXgsXG4gICAgICBjb25zZWN1dGl2ZVRvZ2dsZVN0YXJ0SWQsXG4gICAgICBzZWxlY3QsXG4gICAgICBleHBhbmRBY3Rpb25Sb290LFxuICAgICAgZXhwYW5kU3RhdGVSb290LFxuICAgICAgbWFya1N0YXRlRGlmZixcbiAgICAgIG9uQWN0aW9uQ2xpY2s6IHRoaXMuaGFuZGxlVG9nZ2xlQWN0aW9uLFxuICAgICAgb25BY3Rpb25TaGlmdENsaWNrOiB0aGlzLmhhbmRsZVRvZ2dsZUNvbnNlY3V0aXZlQWN0aW9uLFxuICAgIH07XG5cbiAgICByZXR1cm4gKFxuICAgICAgPGRpdiBzdHlsZT17eyAuLi5zdHlsZXMuY29udGFpbmVyLCBiYWNrZ3JvdW5kQ29sb3I6IHRoZW1lLmJhc2UwMCB9fT5cbiAgICAgICAgeyF0aGlzLnByb3BzLmhpZGVNYWluQnV0dG9ucyAmJiAoXG4gICAgICAgICAgPExvZ01vbml0b3JCdXR0b25CYXJcbiAgICAgICAgICAgIHRoZW1lPXt0aGVtZX1cbiAgICAgICAgICAgIGRpc3BhdGNoPXtkaXNwYXRjaH1cbiAgICAgICAgICAgIGhhc1N0YXRlcz17Y29tcHV0ZWRTdGF0ZXMubGVuZ3RoID4gMX1cbiAgICAgICAgICAgIGhhc1NraXBwZWRBY3Rpb25zPXtza2lwcGVkQWN0aW9uSWRzLmxlbmd0aCA+IDB9XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgICAgPGRpdlxuICAgICAgICAgIHN0eWxlPXtcbiAgICAgICAgICAgIHRoaXMucHJvcHMuaGlkZU1haW5CdXR0b25zXG4gICAgICAgICAgICAgID8gc3R5bGVzLmVsZW1lbnRzXG4gICAgICAgICAgICAgIDogeyAuLi5zdHlsZXMuZWxlbWVudHMsIHRvcDogMzAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICByZWY9e3RoaXMuZ2V0UmVmfVxuICAgICAgICA+XG4gICAgICAgICAgPExvZ01vbml0b3JFbnRyeUxpc3Qgey4uLmVudHJ5TGlzdFByb3BzfSAvPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZGl2PlxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgKExvZ01vbml0b3IgYXMgdW5rbm93bikgYXMgUmVhY3QuQ29tcG9uZW50VHlwZTxcbiAgRXh0ZXJuYWxQcm9wczx1bmtub3duLCBBY3Rpb248dW5rbm93bj4+XG4+ICYge1xuICB1cGRhdGUoXG4gICAgbW9uaXRvclByb3BzOiBFeHRlcm5hbFByb3BzPHVua25vd24sIEFjdGlvbjx1bmtub3duPj4sXG4gICAgc3RhdGU6IERvY2tNb25pdG9yU3RhdGUgfCB1bmRlZmluZWQsXG4gICAgYWN0aW9uOiBEb2NrTW9uaXRvckFjdGlvblxuICApOiBEb2NrTW9uaXRvclN0YXRlO1xuICBkZWZhdWx0UHJvcHM6IERlZmF1bHRQcm9wczx1bmtub3duPjtcbn07XG4iXX0=